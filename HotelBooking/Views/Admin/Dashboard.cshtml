@using System.Collections.Generic
@using HotelBooking.Models
@model IEnumerable<Booking>
@{
    ViewData["Title"] = "Admin Dashboard";
    var role = ViewBag.AdminRole as string;
}

<style>
    /* Styling for the main statistical cards */
    .dashboard-card {
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        min-height: 120px;
    }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

    .card-number {
        font-size: 2.5rem;
        font-weight: bold;
    }

    .card-label {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.8);
    }

    .metric-spacer {
        height: 12px;
    }
</style>
@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        <ul>
            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
            {
                <li>@error.ErrorMessage</li>
            }
        </ul>
    </div>
}
<div class="container-fluid py-5">
    <h1 class="mb-5 text-primary">Administration Dashboard</h1>
    <hr />
    @if (role == "Manager"){
        <h2 class="mb-4">Key Metrics Overview</h2>

        <div class="row">

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card dashboard-card bg-info text-white">
                    <div class="card-body">
                        <p class="card-label">Active Stays</p>
                        <div class="card-number">@ViewBag.checkin</div>
                        <div class="metric-spacer"></div>
                        <small>Guests currently checked in</small>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card dashboard-card bg-success text-white">
                    <div class="card-body">
                        <p class="card-label">Rooms Available Now</p>
                        <div class="card-number"> @ViewBag.RoomsCountAv</div>
                        <div class="metric-spacer mb-3"><small>from total @ViewBag.RoomCount</small></div>
                        <a asp-action="GetAllRooms" class="btn btn-sm btn-outline-light mt-2">Review All Rooms</a>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card dashboard-card bg-warning text-dark">
                    <div class="card-body">
                        <p class="card-label">Stuff Members</p>
                        <div class="card-number">@ViewBag.StuffCount</div>
                        <a asp-action="GetAllStuffs" class="btn btn-sm btn-outline-dark mt-2">Manage Staff</a>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card dashboard-card bg-danger text-white">
                    <div class="card-body">
                        <p class="card-label">feedbacks</p>
                        <div class="card-number">@ViewBag.Comment</div>
                        <a asp-action="AllComments" class="btn btn-sm btn-outline-light mt-2">Review All Comments</a>
                    </div>
                </div>
            </div>
        </div>
    }
    @if (role == "Reciption"){
        <h2 class="mt-5 mb-4">Recent Bookings Activity</h2>

        <div class="mb-3 d-flex align-items-center justify-content-between">

            
            <a class="btn btn-success" asp-action="CreateBooking" asp-controller="Admin" method="get">
                New Client
            </a>

            
            <div class="d-flex align-items-center" style="gap:10px;">

                <input type="text" id="nationalIdSearch" class="form-control" placeholder="Search by National ID" maxlength="14" />
                <button type="button" class="btn btn-primary" id="searchBtn">Search</button>

                
                <button type="button" id="oldClientBtn" class="btn btn-warning w-50" disabled>Old Client</button>

            </div>

        </div>

       
        <div id="searchResult" class="mt-2 fw-bold"></div>

        <input type="text" id="searchBookingId" placeholder="Search National ID" class="form-control mb-2 mt-5" />
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Latest Booking Transactions</h4>
            </div>
            <div class="card-body">
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th>Client Name</th>
                            <th>National ID</th>
                            <th>Booking Date</th>
                            <th>Check Out Date</th>
                            <th>Status</th>
                            <th>Total Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            var today = DateTime.Today;
                            foreach (var booking in Model.OrderByDescending(b => b.checkInTime))
                            {
                                <tr>
                                    <td>@ViewBag.ClientNames[booking.Id]</td>
                                    <td>@ViewBag.ClientNationalIds[booking.Id]</td>
                                    <td>@booking.checkInTime.ToShortDateString()</td>
                                    <td>@(booking.checkOutTime != null ? booking.checkOutTime.Date.ToShortDateString() : "-")</td>
                                    <td>
                                        @{
                                            string badgeClass;
                                            string badgeText;

                                            if (booking.IsCheckedOut)
                                            {
                                                badgeClass = "bg-info";
                                                badgeText = "Completed";
                                            }
                                            else if (booking.IsCheckedIn)
                                            {
                                                badgeClass = "bg-warning text-dark";
                                                badgeText = "Active Stay";
                                            }
                                            else if (booking.checkInTime < today)
                                            {
                                                badgeClass = "bg-danger";
                                                badgeText = "Expired";
                                            }
                                            else
                                            {
                                                badgeClass = "bg-secondary";
                                                badgeText = "Pending";
                                            }
                                        }
                                        <span class="badge @badgeClass">@badgeText</span>
                                    </td>
                                    <td>
                                        @{
                                            string totalPriceDisplay = (booking.TotalPrice > 0) ? booking.TotalPrice.ToString("C") : "-";
                                        }
                                        @totalPriceDisplay
                                    </td>
                                    <td>
                                        @if (!booking.IsCheckedIn && !booking.IsCheckedOut && booking.checkInTime >= today)
                                        {
                                            <form asp-action="CheckIn" method="post" class="d-inline">
                                                <input type="hidden" name="bookingId" value="@booking.Id" />
                                                <button type="submit" class="btn btn-sm btn-success">Check In</button>
                                            </form>
                                            <a asp-controller="User" asp-action="UpdateBooking" asp-route-id="@booking.Id" class="btn btn-sm btn-primary">Update</a>
                                        }

                                        @if (booking.IsCheckedIn && !booking.IsCheckedOut)
                                        {
                                            <form asp-action="CheckOut" method="post" class="d-inline">
                                                <input type="hidden" name="bookingId" value="@booking.Id" />
                                                <button type="submit" class="btn btn-sm btn-danger">Check Out</button>
                                            </form>
                                            <a asp-controller="User" asp-action="UpdateBooking" asp-route-id="@booking.Id" class="btn btn-sm btn-primary">Update</a>
                                        }
                                        <a asp-controller="User" asp-action="ViewBooking" asp-route-id="@booking.Id" class="btn btn-sm btn-info">Details</a>
                                        <form asp-controller="User" asp-action="DeleteBooking" asp-route-id="@booking.Id" method="post" class="d-inline"
                                              onsubmit="return confirm('Are you sure you want to delete this booking?');">
                                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center">No bookings to show</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const searchBtn = document.getElementById("searchBtn");
        const oldClientBtn = document.getElementById("oldClientBtn");
        const searchResult = document.getElementById("searchResult");
        const nationalIdInput = document.getElementById("nationalIdSearch");

        searchBtn.addEventListener("click", function () {
            const nationalId = nationalIdInput.value.trim();
            if (nationalId === "") {
                searchResult.innerText = "Please enter a National ID.";
                oldClientBtn.disabled = true;
                return;
            }

            fetch('/Admin/CheckClientEmail?nationalId=' + encodeURIComponent(nationalId))
                .then(res => res.text())
                .then(email => {
                    if (!email || email === "NotFound" || email === "Email Not Found") {
                        searchResult.innerText = "Client Not Found";
                        oldClientBtn.disabled = true;
                    } else {
                        searchResult.innerHTML = "Client Found → Email: <b>" + email + "</b>";
                        oldClientBtn.disabled = false;
                    }
                })
                .catch(err => {
                    searchResult.innerText = "Error occurred";
                    oldClientBtn.disabled = true;
                });
        });


        oldClientBtn.addEventListener("click", function () {
            const nationalId = nationalIdInput.value.trim();
            if (nationalId) {
                window.location.href = '/Admin/CreateBookingForClient?nationalId=' + encodeURIComponent(nationalId);
            }
        });


        oldClientBtn.disabled = true;
    });
</script>
<script>
    document.getElementById('searchBookingId').addEventListener('keyup', function() {
        const searchValue = this.value.trim().toLowerCase();
        const table = document.querySelector('table tbody');
        const rows = table.querySelectorAll('tr');

        rows.forEach(row => {
            const nationalIdCell = row.cells[1];
            if (nationalIdCell) {
                const cellText = nationalIdCell.textContent.toLowerCase();
                row.style.display = cellText.includes(searchValue) ? '' : 'none';
            }
        });
    });
</script>